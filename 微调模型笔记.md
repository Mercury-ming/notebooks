# 微调大模型数据集

## 1.微调数据集

微调的数据集是定制大模型的关键；真正复杂的工作都是在 **清洗数据、处理、生成数据、归类数据** 上，这些才是影响最后效果的最大难点问题。——散步，[Tianji](https://github.com/SocialAI-tianji/Tianji)作者

我们常见的微调数据集需要符合 **Alpaca格式** ，以我们使用的嬛嬛数据集为例，其样本如下：

```json
{
    "instruction": "小姐，别的秀女都在求中选，唯有咱们小姐想被撂牌子，菩萨一定记得真真儿的——",
    "input": "",
    "output": "嘘——都说许愿说破是不灵的。"
}
```

**字段说明** ：

- `instruction`：任务的指令，模型需要完成的具体操作，一般可以对应到用户输入的 **Prompt** 。
- `input`：任务所需的输入内容。若任务是开放式的，或者不需要明确输入，可以为空字符串。
- `output`：在给定指令和输入的情况下，模型需要生成的期望输出，也就是对应的正确结果或参考答案。

**特点与应用** ：结构简单清晰，易于理解和处理。它明确地将任务指令和输入内容分离开来，能够很好地适用于各种自然语言处理任务，像文本生成、翻译、总结等任务，尤其适合单轮的、以任务为导向的指令微调任务.

### 1.1 Alpaca格式说明

在Alpaca格式下的**指令监督微调**中，**instruction**列对应的内容会与**input**列对应的内容**拼接**后作为**人类指令**，即人类指令为**instruction\input**。而**output**列对应的内容为**模型回答**。如果指定，**system**列对应的内容将被作为**系统提示词**。**history**列是由**多个字符串二元组**构成的**列表**，分别代表历史消息中**每轮对话的指令和回答**。

> **注:** **历史消息**中的**回答内容**也会被**用于模型学习**。

```json
[
  {
	"instruction": "人类指令（必填）",
	"input": "人类输入（选填）",
	"output": "模型回答（必填）",
	"system": "系统提示词（选填）",
	"history": [
	  ["第一轮指令（选填）", "第一轮回答（选填）"],
	  ["第二轮指令（选填）", "第二轮回答（选填）"]
	]
  }
]
```

- 对于上述格式的数据，dataset_info.json中的数据集描述应为：

```json
"数据集名称": {
  "file_name": "data.json",
	"columns": {
	"prompt": "数据集代表提示词的表头名称（默认：instruction）",
	"query": "数据集代表请求的表头名称（默认：input）",
	"response": "数据集代表回答的表头名称（默认：output）",
	"system": "数据集代表系统提示的表头名称（默认：system）",
	"history": "数据集代表历史对话的表头名称（默认：history）"
  }
}
```

- Alpaca格式数据具体示例如下：

```json
  {
	"instruction": "描述一个可以从人工智能技术中受益的医疗应用。",
	"input": "",
	"output": "用于帮助医生诊断疾病的人工智能辅助诊断系统可以被视为一个可以从人工智能技术中受益的医疗应用。这种系统通过使用深度学习算法来分析患者的病史、临床数据和医学影像资料，能够为医生提供准确的诊断建议。\n\n例如，人工智能技术可以用来分析X光片、 CT扫描和MRI扫描图像，帮助医生诊断肺炎，肿瘤，中风等疾病。此外，通过分析大量患者数据，人工智能系统能够找出患病风险较高的人群并预测潜在健康问题，从而为预防性医疗提供有力支持。\n\n这类人工智能系统不仅能够提高诊断准确性，还能帮助医生节约时间，让他们能够更好地关注患者的治疗。因此，人工智能辅助诊断系统是一个可以从人工智能技术中受益的医疗应用，具有广阔的发展前景。",
	"system": "",
	"history": ""
  }
```



<img src='./assets/alpaca格式说明.png'>

此外，还有 **`ShareGPT`** 等格式:

### 1.2 ShareGPT 格式说明

相比Alpaca格式的数据集，**ShareGPT格式**支持**更多的角色种类**，例如**human、gpt、observation、function**等。它们构成一个对象列表呈现在**conversations**列中。

> **注:** 其中**human**和**observation必须**出现在**奇数位置**，**gpt**和**function**必须出现在**偶数位置**。

```json
[
  {
	"conversations": [
	  {
		"from": "human",
		"value": "人类指令"
	  },
	  {
		"from": "function_call",
		"value": "工具参数"
	  },
	  {
		"from": "observation",
		"value": "工具结果"
	  },
	  {
		"from": "gpt",
		"value": "模型回答"
	  }
	]（必填）,
	"system": "系统提示词（选填）",
	"tools": "工具描述（选填）"
  }
]
```

- 对于上述格式的数据，dataset_info.json中的数据集描述应为：

```json
"数据集名称": {
  "file_name": "data.json",
  "formatting": "sharegpt",
  "columns": {
	"messages": "数据集代表消息列表的表头名称（默认：conversations）",
	"system": "数据集代表系统提示的表头名称（默认：system）",
	"tools": "数据集代表工具描述的表头名称（默认：tools）"
  },
  "tags": {
	"role_tag": "消息中代表发送者身份的键名（默认：from）",
	"content_tag": "消息中代表文本内容的键名（默认：value）",
	"user_tag": "消息中代表用户的 role_tag（默认：human）",
	"assistant_tag": "消息中代表助手的 role_tag（默认：gpt）",
	"observation_tag": "消息中代表工具返回结果的 role_tag（默认：observation）",
	"function_tag": "消息中代表工具调用的 role_tag（默认：function_call）",
	"system_tag": "消息中代表系统提示的 role_tag（默认：system）"
  }
}
```

- ShareGPT格式数据具体示例如下：

```json
  {
	"conversations": [
	  {
		"from": "human",
		"value": "你好，我出生于1990年5月15日。你能告诉我我今天几岁了吗？"
	  },
	  {
		"from": "function_call",
		"value": "{\"name\": \"calculate_age\", \"arguments\": {\"birthdate\": \"1990-05-15\"}}"
	  },
	  {
		"from": "observation",
		"value": "{\"age\": 31}"
	  },
	  {
		"from": "gpt",
		"value": "根据我的计算，你今天31岁了。"
	  }
	],
	"tools": "[{\"name\": \"calculate_age\", \"description\": \"根据出生日期计算年龄\", \"parameters\": {\"type\": \"object\", \"properties\": {\"birthdate\": {\"type\": \"string\", \"description\": \"出生日期以YYYY-MM-DD格式表示\"}}, \"required\": [\"birthdate\"]}}]"
  }
```



<img src='./assets/shareGPT格式说明.png'>

### 1.3 推理集格式说明

在**文本生成任务**中，**推理集**用于**检测模型微调效果**，平台支持**jsonl格式**和**csv格式**。

- jsonl格式文件要求如下:

> 1. **jsonl文件**内每条**数据格式**要求为 **{“input”:“你的问题”，“target”:“回答内容”}**。
> 2. 每一行表示一组数据，**每组数据**中的**input和target加起来之和**字符数**不超过4000个字符(包括中英文、数字、符号等)**，超出部分将被截断。
> 3. 支持**文本文件类型为JSONL**，**编码**仅支持**UTF-8**，单次上传**限制1个文件**。
> 4. 训练集数量**spark pro≥1500条**，**sparklite≥100条**，**文件<500M**;**测试集数量范围为10-200条**。

- jsonl具体数据格式示例如下：

```text
{"input":"买房银行贷款贷多少年。","target":"1、个人住房贷款最长为30年；2、个人商业贷款最长期限为10年。"}
```

- csv格式文件要求如下:

> 1. 文件内单组数据**表格一行代表一组数据**，**第一列为input**，**第二列为target**。
> 2. **每一行表示一组数据**，**每组数据**中的**input和target加起来之和**字符数**不超过4000个字符(包括中英文、数字、符号等)**，超出部分将被截断。
> 3. 支持**文本文件类型为 csv**，**编码**仅支持**UTF-8**，单次上传**限制1个文件**。
> 4. 训练集数量**spark pro≥1500条**，**sparklite>100条**，**文件<500M**;**测试集数量范围为10-200条**。

- csv具体数据格式示例如下：

| input                                | target                                                       |
| ------------------------------------ | ------------------------------------------------------------ |
| 大润发住房公积金贷二手房能贷多少钱。 | 各地公积金政策有所不同，建议通过官网查询或者咨询当地公积金管理中心，官方电话是12#29。 |
| ...                                  | ...                                                          |

JSON和 JSONL数据格式解释：

> JSON（JavaScript Object Notation）和 JSONL（JSON Lines）都是用于数据交换的文本格式，但它们在结构和使用场景上有所不同。
>
> JSON 是一种轻量级的数据交换格式，易于人阅读和编写，同时也便于机器解析和生成。它采用键值对的形式表示数据，并使用逗号分隔不同的元素。JSON 能够描述复杂的数据结构，如数组和嵌套对象。在 JSON 文件中，所有的数据都存储在一个根对象中，可以包含多个嵌套的对象、数组和基本数据类型。这种格式适合存储结构化的数据，如配置文件、API 响应等，并且可以一次性读取整个文件，解析成一个 JSON 对象，允许随机访问其中的数据。
>
> JSONL，又称为 JSON Lines，是一种特殊的 JSON 文件格式，它将多个 JSON 对象按行分隔存储。每行都是一个独立的 JSON 对象，这种格式没有逗号或其他分隔符，每个 JSON 对象占据一行。这种格式使得数据更加清晰易读，特别是在处理大量数据时。JSONL 适合存储每行为独立记录的数据，如日志、传感器数据等，并且可以逐行读取和处理数据，一次处理一行。JSONL 文件格式在处理大量数据、写入文本文件或日志文件以及实时处理数据流等场景中具有优势，因为它可以逐行读取和处理数据，而不需要一次性加载整个数据集合。
>
> jsonl文件的结构非常简单，每行都是一个有效的json对象，行与行之间没有逗号或其他分隔符。例如：
>
> ```json
> {"name": "Alice", "age": 30, "city": "New York"}
> {"name": "Bob", "age": 25, "city": "San Francisco"}
> {"name": "Charlie", "age": 35, "city": "Los Angeles"}
> ```
>
> 在选择使用 JSON 还是 JSONL 时，应考虑数据的使用场景。如果数据量不大，或者需要一次性传输和处理完整的数据结构，JSON 可能更合适。而当处理的数据量非常大，或者需要逐行读取和处理数据以节省内存和提高处理速度时，JSONL 则是一个更好的选择。例如，在实时数据分析、流式计算等场景中，JSONL 格式可以提供更高效的数据处理方式。
>
> 总的来说，JSONL 文件格式适用于处理大量数据、写入文本文件或日志文件以及实时处理数据流等场景。它具有简洁、易读、易处理等优点，能够提高数据处理效率并降低复杂度。在实际应用中，根据具体需求选择合适的文件格式非常重要。对于简单的数据交换和存储场景，传统的 JSON 格式可能更合适。而对于需要高效处理大量数据、写入文本文件或实时处理数据流的场景，JSONL 格式则更具优势。



## 2. 微调Qwen-v2.5-7B-instruct模型角色模拟-甄嬛

详见Datawhale-AI活动：15分钟，定制你的第一个专属模型！@[DataWale](https://www.datawhale.cn/activity/110/21/76?rankingPage=1)

